<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estado de Cuenta - Club Atenas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="../css/estado-cuenta.css">
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="mb-0 fw-bold">Consulta de Estado de Cuenta</h1>
          <p class="mb-0 opacity-90">Club Atenas - Sistema de Gestión</p>
        </div>
        <div>
          <a href="/html/menu.html" class="btn btn-outline-light me-2">Volver al menú</a>
          <a href="/auth/logout" class="btn btn-outline-light">Cerrar Sesión</a>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Tabla de socios registrados -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-people me-2"></i>Lista de Socios Registrados</h5>
      </div>
      <div class="card-body p-0">
        <div class="table-container">
          <table class="table table-striped table-hover mb-0" id="tablaSocios">
            <thead>
              <tr>
                <th>DNI</th>
                <th>Nombre Completo</th>
                <th>Teléfono</th>
                <th>Tipo de Socio</th>
                <th>Estado</th>
                <th>Acción</th>
              </tr>
            </thead>
            <tbody>
              <!-- Se llena con JS -->
            </tbody>
          </table>
        </div>
        <div id="tablaMensaje" class="p-4 text-center text-muted"></div>
      </div>
    </div>

    <!-- Búsqueda por DNI -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row justify-content-center">
          <div class="col-md-6">
            <label class="form-label fw-bold">Buscar socio por DNI</label>
            <div class="input-group input-group-lg">
              <input type="text" id="dni" class="form-control" placeholder="Ej. 71234567" maxlength="8" />
              <button class="btn btn-primary" id="buscarBtn">
                <i class="bi bi-search me-2"></i>Buscar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resultado de la consulta -->
    <div id="resultado" class="mt-4"></div>
  </div>

  <footer>
    <div class="container">
      <p class="mb-0">&copy; 2025 Club Atenas. Sistema de Gestión de Socios.</p>
    </div>
  </footer>

  <script>
    // Cargar lista de socios al iniciar la página
    document.addEventListener('DOMContentLoaded', async () => {
      const tbody = document.querySelector('#tablaSocios tbody');
      const mensaje = document.getElementById('tablaMensaje');

      try {
        const res = await fetch('/api/socios/lista', { credentials: 'include' });
        const data = await res.json();

        if (!data.success || data.socios.length === 0) {
          mensaje.innerHTML = '<p class="text-muted">No hay socios registrados aún.</p>';
          return;
        }

        tbody.innerHTML = '';
        data.socios.forEach(socio => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${socio.dni}</strong></td>
            <td>${socio.nombre}</td>
            <td>${socio.telefono || '-'}</td>
            <td><span class="badge bg-secondary">${socio.tipo_socio}</span></td>
            <td><span class="badge ${socio.estado === 'activo' ? 'bg-success' : 'bg-danger'}">${socio.estado}</span></td>
            <td>
              <button class="btn btn-sm btn-primary seleccionar-socio" data-dni="${socio.dni}">
                <i class="bi bi-check2"></i> Seleccionar
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Evento para seleccionar socio desde la tabla
        document.querySelectorAll('.seleccionar-socio').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const dni = e.target.closest('button').dataset.dni;
            document.getElementById('dni').value = dni;
            document.getElementById('buscarBtn').click(); // Ejecuta la búsqueda automáticamente
          });
        });

      } catch (err) {
        mensaje.innerHTML = '<p class="text-danger">Error al cargar la lista de socios.</p>';
      }
    });

    // Búsqueda por DNI (tu código original corregido)
    document.getElementById('buscarBtn').addEventListener('click', async () => {
      const dni = document.getElementById('dni').value.trim();
      const resultado = document.getElementById('resultado');

      if (!dni || dni.length !== 8 || isNaN(dni)) {
        resultado.innerHTML = '<div class="alert alert-warning">Ingrese un DNI válido de 8 dígitos</div>';
        return;
      }

      resultado.innerHTML = '<div class="alert alert-info">Buscando...</div>';

      try {
        const res = await fetch(`/api/pagos/estado-cuenta/${dni}`, {
          credentials: 'include'
        });

        if (!res.ok) {
          const errorText = await res.text();
          console.error('Error HTTP:', res.status, errorText);
          resultado.innerHTML = `<div class="alert alert-danger">Error ${res.status}: ${res.statusText}</div>`;
          return;
        }

        const data = await res.json();

        if (!data.success) {
          resultado.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
          return;
        }

        const socio = data.socio;
        const deuda = Number(data.deuda_total) || 0;
        const facturas = data.facturas;

        let html = `
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h4>${socio.nombre} - DNI: ${socio.dni}</h4>
            </div>
            <div class="card-body">
        `;

        if (deuda <= 0) {
          html += `<div class="alert alert-success"><strong>El socio se encuentra al día</strong> (o con saldo a favor)</div>`;
        } else {
          html += `
            <h3 class="text-danger">Deuda total: S/ ${deuda.toFixed(2)}</h3>
            <hr>
            <h5>Detalle de facturas pendientes:</h5>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Factura</th>
                  <th>Emisión</th>
                  <th>Vencimiento</th>
                  <th>Concepto</th>
                  <th class="text-end">Monto</th>
                </tr>
              </thead>
              <tbody>
          `;

          facturas.forEach(f => {
            f.detalles.forEach(d => {
              const montoDetalle = Number(d.monto) || 0;
              html += `
                <tr>
                  <td>${f.id}</td>
                  <td>${f.fecha_emision}</td>
                  <td>${f.fecha_vencimiento}</td>
                  <td>${d.concepto}</td>
                  <td class="text-end">S/ ${montoDetalle.toFixed(2)}</td>
                </tr>
              `;
            });
          });

          html += `
              </tbody>
            </table>
          `;
        }

        html += `
            </div>
          </div>
        `;

        resultado.innerHTML = html;

        // Scroll suave al resultado
        resultado.scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        console.error('Error:', err);
        resultado.innerHTML = '<div class="alert alert-danger">Error de conexión. Verifica que estés logueado y hayas entrado desde el menú.</div>';
      }
    });
  </script>
</body>
</html>