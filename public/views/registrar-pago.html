<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrar Pago - Club Atenas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../css/registrar-pago.css">
  </head>
  <body>
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Registrar Pago</h2>
        <div>
          <a href="/html/menu.html" class="btn btn-secondary me-2">Volver al menú</a>
          <a href="/auth/logout" class="btn btn-outline-danger">Cerrar Sesión</a>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">DNI del socio</label>
              <div class="input-group mb-3">
                <input type="text" id="dni" class="form-control" placeholder="Ej. 71234567" maxlength="8" />
                <button class="btn btn-primary" id="cargarBtn">Cargar socio</button>
              </div>
            </div>
          </div>

          <div id="infoSocio" class="mt-4" style="display: none">
            <div class="alert alert-info">
              <strong>Socio:</strong> <span id="nombreSocio"></span> |
              <strong>Deuda actual:</strong> S/ <span id="deudaActual">0.00</span>
            </div>

            <hr />

            <form id="pagoForm">
              <div class="row">
                <div class="col-md-6">
                  <label class="form-label">Monto a pagar</label>
                  <input type="number" step="0.01" id="monto" class="form-control" required min="0.01" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Método de pago</label>
                  <select id="metodo" class="form-select" required>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Transferencia">Transferencia</option>
                  </select>
                </div>
              </div>

              <div class="mt-4">
                <button type="submit" class="btn btn-success btn-lg">
                  Confirmar y Registrar Pago
                </button>
              </div>
            </form>

            <div id="mensaje" class="mt-3"></div>
          </div>

          <div id="mensajeGeneral" class="mt-3"></div>
        </div>
      </div>
    </div>

    <script>
      let socioId = null;
      let deudaActual = 0;

      const mostrarMensaje = (texto, tipo = "danger") => {
        const mensajeGeneral = document.getElementById("mensajeGeneral");
        mensajeGeneral.innerHTML = `<div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
          ${texto}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      };

      document.getElementById("cargarBtn").addEventListener("click", async () => {
        const dni = document.getElementById("dni").value.trim();
        const infoSocio = document.getElementById("infoSocio");
        const mensajeGeneral = document.getElementById("mensajeGeneral");
        mensajeGeneral.innerHTML = "";

        if (!dni || dni.length !== 8 || isNaN(dni)) {
          mostrarMensaje("Ingrese un DNI válido de 8 dígitos", "warning");
          return;
        }

        try {
          const res = await fetch(`/api/pagos/estado-cuenta/${dni}`, {
            credentials: "include"
          });

          if (!res.ok) {
            const errorText = await res.text();
            console.error("Error HTTP al cargar socio:", res.status, errorText);
            if (res.status === 401) {
              mostrarMensaje("Sesión expirada o no autorizada. Por favor, inicia sesión nuevamente.", "danger");
            } else {
              mostrarMensaje(`Error ${res.status}: ${res.statusText}`, "danger");
            }
            infoSocio.style.display = "none";
            return;
          }

          const data = await res.json();

          if (!data.success) {
            mostrarMensaje(data.message || "Socio no encontrado", "danger");
            infoSocio.style.display = "none";
            return;
          }

          socioId = data.socio.id;
          deudaActual = Number(data.deuda_total) || 0;

          document.getElementById("nombreSocio").textContent =
            `${data.socio.nombre} (DNI: ${data.socio.dni})`;
          document.getElementById("deudaActual").textContent = deudaActual.toFixed(2);

          infoSocio.style.display = "block";
          document.getElementById("monto").value = deudaActual > 0 ? deudaActual.toFixed(2) : "";
          
          mostrarMensaje("Socio cargado correctamente", "success");
        } catch (err) {
          console.error("Error de conexión:", err);
          mostrarMensaje("Error de conexión. Asegúrate de haber iniciado sesión desde el menú principal.", "danger");
        }
      });

      document.getElementById("pagoForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const monto = parseFloat(document.getElementById("monto").value);
        const metodo = document.getElementById("metodo").value;
        const mensaje = document.getElementById("mensaje");

        if (isNaN(monto) || monto <= 0) {
          mensaje.innerHTML = '<div class="alert alert-warning">Ingrese un monto válido mayor a 0</div>';
          return;
        }

        mensaje.innerHTML = '<div class="alert alert-info">Procesando pago...</div>';

        try {
          const res = await fetch("/api/pagos/registrar", {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ socio_id: socioId, monto, metodo })
          });

          if (!res.ok) {
            const errorText = await res.text();
            console.error("Error HTTP al registrar pago:", res.status, errorText);
            if (res.status === 401) {
              mensaje.innerHTML = '<div class="alert alert-danger">Sesión no autorizada. Por favor, inicia sesión nuevamente.</div>';
            } else {
              mensaje.innerHTML = `<div class="alert alert-danger">Error ${res.status}: ${res.statusText}</div>`;
            }
            return;
          }

          const data = await res.json();

          if (data.success) {
            mensaje.innerHTML = `<div class="alert alert-success"><strong>${data.message}</strong></div>`;
            if (data.recibo_url) {
              const btn = document.createElement("a");
              btn.href = data.recibo_url;
              btn.className = "btn btn-primary mt-3";
              btn.textContent = "Descargar Recibo PDF";
              btn.target = "_blank";
              btn.rel = "noopener";
              mensaje.appendChild(document.createElement("br"));
              mensaje.appendChild(btn);
            }
            setTimeout(() => location.reload(), 4000);
          } else {
            mensaje.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
          }
        } catch (err) {
          console.error("Error al registrar pago:", err);
          mensaje.innerHTML = '<div class="alert alert-danger">Error de conexión o sesión expirada. Intenta nuevamente.</div>';
        }
      });
    </script>
  </body>
</html>